using System ;
using System.IO ;
using System.Runtime.CompilerServices ;
using Castle.DynamicProxy ;
using NLog ;
using WpfApp.Core.Logging ;

namespace WpfApp.Proxy
{
    /// <summary>Attempt to hook into NLog and fix it up for my application.</summary>
    /// <autogeneratedoc />
    /// TODO Edit XML Comment Template for LoggerProxyHelper
    public class LoggerProxyHelper
    {
        /// <summary>
        ///     Initializes a new instance of the
        ///     <see
        ///         cref="T:System.Object" />
        ///     class.
        /// </summary>
        public LoggerProxyHelper ( ProxyGenerator generator ) { Generator = generator ; }

        /// <summary>
        ///     Initializes a new instance of the <see cref="T:System.Object" />
        ///     class.
        /// </summary>
        public LoggerProxyHelper ( ProxyGenerator generator , LogDelegates.LogMethod logMethod )
        {
            Generator    = generator ;
            UseLogMethod = logMethod ;
        }

        /// <summary>Gets the generator.</summary>
        /// <value>The generator.</value>
        /// <autogeneratedoc />
        /// TODO Edit XML Comment Template for Generator
        public ProxyGenerator Generator { get ; }

        /// <summary>Gets or sets the use log method.</summary>
        /// <value>The use log method.</value>
        /// <autogeneratedoc />
        /// TODO Edit XML Comment Template for UseLogMethod
        public LogDelegates.LogMethod UseLogMethod { get ; set ; }

        /// <summary>Creates the log factory.</summary>
        /// <param name="logFactory">The log factory.</param>
        /// <returns></returns>
        /// <autogeneratedoc />
        /// TODO Edit XML Comment Template for CreateLogFactory
        public LogFactory CreateLogFactory ( LogFactory logFactory )
        {
            if ( logFactory == null )
            {
                logFactory = LogManager.LogFactory ;
            }

            var opts = new ProxyGenerationOptions ( new LoggerFactoryHook ( UseLogMethod ) ) ;
            opts.Initialize ( ) ;
            var proxy = ( LogFactory ) Generator.CreateClassProxyWithTarget (
                                                                             logFactory.GetType ( )
                                                                           , Type.EmptyTypes
                                                                           , logFactory
                                                                           , opts
                                                                           , new
                                                                                 LogFactoryInterceptor (
                                                                                                        Generator
                                                                                                      , UseLogMethod
                                                                                                       )
                                                                            ) ;
            return proxy ;
        }

        /// <summary>Gets the current class logger.</summary>
        /// <param name="path">The path.</param>
        /// <returns></returns>
        /// <autogeneratedoc />
        /// TODO Edit XML Comment Template for GetCurrentClassLogger
        public static Logger GetCurrentClassLogger ( [ CallerFilePath ] string path = null )
        {
            var name = "default" ;
            if ( path != null )
            {
                name = Path.GetFileNameWithoutExtension ( path ) ;
            }

            // fixme
            var myLogFactory = LogManager.Configuration?.LogFactory as MyLogFactory ;
            if ( myLogFactory == null )

            {
                System.Diagnostics.Debug.WriteLine ( "no log factory of my type" ) ;
                return LogManager.GetCurrentClassLogger ( ) ;
                // throw new NotImplementedException ( ) ;
            }

            System.Diagnostics.Debug.WriteLine (
                             myLogFactory.GetDoLogMessage ( ) != null
                                 ? myLogFactory.GetDoLogMessage ( ).ToString ( )
                                 : "no do log  message"
                            ) ;

            var logger = myLogFactory.GetLogger ( name ) ;
            return logger ;
        }
    }
}