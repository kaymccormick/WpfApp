#region header
// Kay McCormick (mccor)
// 
// PsProject
// WpfTestApp
// ProxyUtils.cs
// 
// 2020-02-01-6:58 AM
// 
// ---
#endregion
using System ;
using System.Collections.Generic ;
using System.Collections.ObjectModel ;
using System.ComponentModel ;
using System.IO ;
using System.Linq ;
using System.Reflection ;
using System.Threading ;
using System.Windows.Markup ;
using System.Xaml ;
using System.Xaml.Schema ;
using System.Xml ;
using Castle.DynamicProxy ;
using JetBrains.Annotations ;
using XamlReader = System.Xaml.XamlReader ;

namespace WpfApp
{
    internal class ProxyUtilsBase
    {
        // ReSharper disable once NotAccessedField.Local
        private          Action < string > _writeOut ;
        private readonly IInterceptor      _interceptor ;

        /// <summary>The proxy generator</summary>
        /// <autogeneratedoc />
        /// TODO Edit XML Comment Template for _proxyGenerator
        protected static readonly ProxyGenerator ProxyGenerator = new ProxyGenerator ( ) ;

        /// <summary>Initializes a new instance of the <see cref="ProxyUtilsBase"/> class.</summary>
        /// <param name="writeOut"></param>
        /// <param name="interceptor"></param>
        protected ProxyUtilsBase ( Action < string > writeOut , IInterceptor interceptor )
        {
            _writeOut    = writeOut ;
            _interceptor = interceptor ;
            //_interceptor = new BaseInterceptorImpl ( _writeOut , _proxyGenerator ) ;
        }

        /// <summary>Creates the interceptor.</summary>
        /// <param name="out">The out.</param>
        /// <returns></returns>
        /// <autogeneratedoc />
        /// TODO Edit XML Comment Template for CreateInterceptor
        // ReSharper disable once UnusedMember.Global
        public static IInterceptor CreateInterceptor ( Action < string > @out )
        {
            return new BaseInterceptorImpl ( @out ) ;
        }

        // ReSharper disable once UnusedMember.Global
        public string DumpIt ( object instance )
        {
            var stringWriter = CreateStringWriter ( ) ;

            var xmlWriterProxy = CreateXmlWriter ( stringWriter ) ;
            var context = CreateXamlSchemaContext ( ) ;
            var settings = CreateXamlObjectReaderSettings ( ) ;
            var reader = CreateXamlObjectReader ( instance , context , settings ) ;

            var xamlWriterProxy = CreateXamlXmlWriter ( xmlWriterProxy , context ) ;


            try
            {
                XamlServices.Transform ( ( XamlReader ) reader , xamlWriterProxy , true ) ;
                //XamlServices.Save (xamlWriterProxy , this ) ;
            }
            catch ( Exception ex )
            {
                Console.WriteLine ( ex ) ;
            }

            return stringWriter.ToString ( ) ;
        }

        /// <summary>Creates the xaml XML writer.</summary>
        /// <param name="xmlWriterProxy">The XML writer proxy.</param>
        /// <param name="context">The context.</param>
        /// <returns></returns>
        /// <autogeneratedoc />
        /// TODO Edit XML Comment Template for CreateXamlXmlWriter
        // ReSharper disable once VirtualMemberNeverOverridden.Global
        protected virtual XamlXmlWriter CreateXamlXmlWriter (
            XmlWriter         xmlWriterProxy
          , XamlSchemaContext context
        )
        {
            var xamlWriterProxy = ( XamlXmlWriter ) ProxyGenerator.CreateClassProxy (
                                                                                     typeof (
                                                                                         XamlXmlWriter
                                                                                     )
                                                                                   , new object[]
                                                                                     {
                                                                                         xmlWriterProxy
                                                                                       , context
                                                                                     }
                                                                                   , _interceptor
                                                                                    ) ;
            return xamlWriterProxy ;
        }

        /// <summary>Creates the xaml object reader.</summary>
        /// <param name="instance">The instance.</param>
        /// <param name="context">The context.</param>
        /// <param name="settings">The settings.</param>
        /// <returns></returns>
        /// <autogeneratedoc />
        /// TODO Edit XML Comment Template for CreateXamlObjectReader
        // ReSharper disable once VirtualMemberNeverOverridden.Global
        protected virtual object CreateXamlObjectReader (
            object                   instance
          , XamlSchemaContext        context
          , XamlObjectReaderSettings settings
        )
        {
            return ProxyGenerator.CreateClassProxy (
                                                    typeof ( XamlObjectReader )
                                                  , new[] { instance , context , settings }
                                                  , _interceptor
                                                   ) ;
        }

        /// <summary>Creates the xaml object reader settings.</summary>
        /// <returns></returns>
        /// <autogeneratedoc />
        /// TODO Edit XML Comment Template for CreateXamlObjectReaderSettings
        // ReSharper disable once VirtualMemberNeverOverridden.Global
        protected virtual XamlObjectReaderSettings CreateXamlObjectReaderSettings ( )
        {
            return new XamlObjectReaderSettings ( )
                   {
                       AllowProtectedMembersOnRoot      = true
                     , RequireExplicitContentVisibility = false
                     , ValuesMustBeString               = false
                   } ;
        }

        /// <summary>Creates the XML writer.</summary>
        /// <param name="stringWriter">The string writer.</param>
        /// <returns></returns>
        /// <autogeneratedoc />
        /// TODO Edit XML Comment Template for CreateXmlWriter
        // ReSharper disable once VirtualMemberNeverOverridden.Global
        protected virtual XmlWriter CreateXmlWriter ( StringWriter stringWriter )
        {
            var x = XmlWriter.Create ( stringWriter ) ;
            var xmlWriterProxy = ProxyGenerator.CreateClassProxyWithTarget ( x , _interceptor ) ;
            return xmlWriterProxy ;
        }

        /// <summary>Creates the string writer.</summary>
        /// <returns></returns>
        /// <autogeneratedoc />
        /// TODO Edit XML Comment Template for CreateStringWriter
        // ReSharper disable once VirtualMemberNeverOverridden.Global
        protected virtual StringWriter CreateStringWriter ( )
        {
            return ProxyGenerator.CreateClassProxy < StringWriter > ( _interceptor ) ;
        }

        /// <summary>Creates the xaml schema context.</summary>
        /// <returns></returns>
        /// <autogeneratedoc />
        /// TODO Edit XML Comment Template for CreateXamlSchemaContext
        // ReSharper disable once VirtualMemberNeverOverridden.Global
        protected virtual XamlSchemaContext CreateXamlSchemaContext ( )
        {
            return ProxyGenerator.CreateClassProxy < XamlSchemaContext > ( _interceptor ) ;
        }

        /// <summary>Creates the proxy.</summary>
        /// <param name="writeLine">The write line.</param>
        /// <param name="interceptor">The interceptor.</param>
        /// <returns></returns>
        /// <autogeneratedoc />
        /// TODO Edit XML Comment Template for CreateProxy
        // ReSharper disable once UnusedMember.Global
        public static ProxyUtils CreateProxy (
            Action < string > writeLine
          , IInterceptor      interceptor
        )
        {
            return ( ProxyUtils ) ProxyGenerator.CreateClassProxy (
                                                                   typeof ( ProxyUtils )
                                                                 , new object[]
                                                                   {
                                                                       writeLine , interceptor
                                                                   }
                                                                 , interceptor
                                                                  ) ;
        }
    }

    /// <summary></summary>
    /// <seealso cref="ProxyUtilsBase" />
    /// <autogeneratedoc />
    /// TODO Edit XML Comment Template for ProxyUtils
    internal class ProxyUtils : ProxyUtilsBase
    {
        /// <summary>Initializes a new instance of the <see cref="T:System.Object" /> class.</summary>
        public ProxyUtils ( Action < string > writeOut , IInterceptor interceptor ) : base (
                                                                                            writeOut
                                                                                          , interceptor
                                                                                           )
        {
        }
    }

    /// <summary></summary>
    /// <seealso cref="Castle.DynamicProxy.IInterceptor" />
    /// <autogeneratedoc />
    /// TODO Edit XML Comment Template for BaseInterceptor
    public abstract class BaseInterceptor : IInterceptor
    {
        /// <summary>Gets the proxy generator.</summary>
        /// <value>The proxy generator.</value>
        /// <autogeneratedoc />
        /// TODO Edit XML Comment Template for ProxyGenerator
        protected ProxyGenerator ProxyGenerator { get ; }

        /// <summary>The write</summary>
        /// <autogeneratedoc />
        /// TODO Edit XML Comment Template for Write
        protected readonly Action < string > Write = null ;

        /// <summary>The write line</summary>
        /// <autogeneratedoc />
        /// TODO Edit XML Comment Template for WriteLine
        protected Action < string > WriteLine ;

        /// <summary>Initializes a new instance of the <see cref="BaseInterceptor"/> class.</summary>
        /// <autogeneratedoc />
        /// TODO Edit XML Comment Template for #ctor
        protected BaseInterceptor ( ProxyGenerator proxyGenerator )
        {
            ProxyGenerator = proxyGenerator ;
        }

        /// <summary>Dumps the invocation.</summary>
        /// <param name="invocation">The invocation.</param>
        /// <param name="callDepth">The call depth.</param>
        /// <autogeneratedoc />
        /// TODO Edit XML Comment Template for DumpInvocation
        protected void DumpInvocation ( [ NotNull ] IInvocation invocation , int callDepth )
        {
            if ( invocation == null )
            {
                throw new ArgumentNullException ( nameof ( invocation ) ) ;
            }

            var c = Depth ( callDepth ) ;

            var f = FormatInvocation ( invocation , c ) ;
            if ( Write == null )
            {
                WriteLine ( f ) ;
            }
            else
            {
                Write ( f ) ;
            }
        }


        private string FormatInvocation ( IInvocation invocation , string c )
        {
            var args = invocation.Method.IsSpecialName && invocation.Arguments.Length == 0
                           ? ""
                           :
                           invocation.Arguments.Length == 0
                               ?
                               "( )"
                               : "("
                                 + string.Join (
                                                ", "
                                              , invocation
                                               .Arguments.Select (
                                                                  ( o , i ) => FormatArgument (
                                                                                               invocation
                                                                                             , o
                                                                                             , i
                                                                                              )
                                                                 )
                                               .ToArray ( )
                                               )
                                         .PadRight ( 40 )
                                 + " )" ;
            return c + "\t" + MethodSpec ( invocation ) + args ;
        }

        private string FormatArgument ( IInvocation invocation , object arg1 , int arg2 )
        {
            var q = FormatTypeAndValue ( arg1 ) ;
            var name = invocation.Method.GetParameters ( )[ arg2 ].Name ;
            return $"{name}: {q}" ;
        }

        private string FormatTypeAndValue ( object o )
        {
            if ( o == null )
            {
                return "null" ;
            }

            var type = FormatTyp ( o.GetType ( ) ) + " " ;

            if ( o is Type )
            {
                type = "" ;
            }

            var formatValue = FormatValue ( o , out var wantType ) ;
            return wantType ? $"{type}{formatValue}" : formatValue ;
        }

        private static string Depth ( int callDepth )
        {
            var c = '⟳' ;
            return $"{new string ( c , callDepth ),- 8}" ;
            //return char.ConvertFromUtf32 ( 0x2460 + callDepth - 1 ) ;
        }

        /// <summary>Dumps the return value.</summary>
        /// <param name="invocation">The invocation.</param>
        /// <param name="callDepth">The call depth.</param>
        /// <param name="continuation">if set to <c>true</c> [continuation].</param>
        /// <autogeneratedoc />
        /// TODO Edit XML Comment Template for DumpReturnValue
        protected void DumpReturnValue (
            IInvocation invocation
          , int         callDepth
          , bool        continuation
        )
        {
            var c = Depth ( callDepth ) ;
            if ( invocation.ReturnValue != null )
            {
                var f = ( continuation
                              ? ""
                              : c
                                + "\t"
                                + MethodSpec ( invocation )
                                + "\t"
                                + //invocation.TargetType + "."+ invocation.Method.Name +
                                "\t\t" )
                        + " ➦ "
                        + FormatReturnValue ( invocation , invocation.ReturnValue ) ;
                WriteLine ( f ) ;
            }
        }

        // ReSharper disable once UnusedParameter.Local
        private string FormatReturnValue ( IInvocation invocation , object r )
        {
            return FormatValue ( r , out _ ) ;
        }

        private static string FormatValue ( object r , out bool b1 )
        {
            b1 = false ;
            if ( r is bool b )
            {
                var val = b ? "⊨" : "⊭" ;
                return val ;
            }
            else if ( r is Type t )
            {
                var rr = t.UnderlyingSystemType == t ? "" : "𝓡" ;
                return $"{rr}𝒯 {FormatTyp ( t.UnderlyingSystemType )}" ;
            }
            else if ( r is XamlType xt )
            {
                return "𝓧" + FormatValue ( xt.UnderlyingType , out b1 ) ;
            }
            else if ( r is string ss )
            {
                return ss ;
            }
            else
            {
                if ( r is ICollection < object > col )
                {
                    var q = from o in col select FormatValue ( o , out b ) ;
                    b1 = true ;
                    return string.Join ( ", " , q ) ;
                }
            }

            b1 = true ;
            return r.ToString ( ) ;
        }

        // ReSharper disable once UnusedMember.Local
        private static string FormatValue < T > ( ICollection < T > r , out bool b1 )
        {
            b1 = true ;
            return string.Join ( ", " , r.Select ( v => FormatValue ( v , out _ ) ) ) ;
        }

        /// <summary>Formats the typ.</summary>
        /// <param name="type">The type.</param>
        /// <returns></returns>
        /// <autogeneratedoc />
        /// TODO Edit XML Comment Template for FormatTyp
        protected static string FormatTyp ( Type type )
        {
            if ( type.IsGenericType )
            {
                return FormatConstructedGenericType ( type ) ;
            }

            var typeName = type.Name ;
            return Alter ( typeName ) ;
        }

        private static string FormatConstructedGenericType ( Type type )
        {
            var type2 = type.GetGenericTypeDefinition ( ) ;
            return Alter (
                          $"{type2.Name}<{string.Join ( "," , type.GenericTypeArguments.Select ( ( type1 , i ) => FormatTyp ( type1 ) ) )}>"
                         ) ;
        }

        private static string Alter ( string s )
        {
            return s.Replace ( "<" , " 〈 " )
                    .Replace ( ">" , " 〉 " )
                    .Replace ( "[" , " 【 " )
                    .Replace ( "]" , " 】 " )
                    .Replace ( "`" , "❛" ) ;
        }

        private static string MethodSpec ( IInvocation invocation )
        {
            var declType = invocation.Method.DeclaringType ;
            var formatTyp = FormatTyp ( declType ) ;
            var type = invocation.TargetType ;
            var typ = FormatTyp ( type ) ;

            var m = " " + invocation.Method.Name ;
            if ( invocation.Method.IsSpecialName
                 && invocation.Method.Name.StartsWith ( "get_" ) )
            {
                m = $"𝜙 {invocation.Method.Name.Substring ( 4 )}" ;
            }

            return ( declType == type ? $"{formatTyp,33}" : $"{formatTyp,16} {typ,16}" ) + " " + m ;
        }

        /// <summary>Intercepts the specified invocation.</summary>
        /// <param name="invocation">The invocation.</param>
        /// <autogeneratedoc />
        /// TODO Edit XML Comment Template for Intercept
        public abstract void Intercept ( IInvocation invocation ) ;
    }

    /// <summary></summary>
    /// <seealso cref="BaseInterceptor" />
    /// <autogeneratedoc />
    /// TODO Edit XML Comment Template for BaseInterceptorImpl
    public class BaseInterceptorImpl : BaseInterceptor
    {
        private          int         _callDepth ;
        private readonly Stack < X > _stack = new Stack < X > ( ) ;

        /// <summary>Initializes a new instance of the <see cref="BaseInterceptorImpl"/> class.</summary>
        /// <param name="out">The out.</param>
        /// <param name="generator">The generator.</param>
        /// <autogeneratedoc />
        /// TODO Edit XML Comment Template for #ctor
        public BaseInterceptorImpl ( Action < string > @out , ProxyGenerator generator = null ) :
            base ( generator )
        {
            WriteLine = @out ;
        }

        /// <summary>Intercepts the specified invocation.</summary>
        /// <param name="invocation">The invocation.</param>
        /// <autogeneratedoc />
        /// TODO Edit XML Comment Template for Intercept
        public override void Intercept ( IInvocation invocation )
        {
            Interlocked.Increment ( ref _callDepth ) ;
            var x = _stack.Any ( ) ? _stack.Peek ( ) : null ;
            var myX = new X ( ) ;
            _stack.Push ( myX ) ;
            var writeLine = WriteLine ;
            if ( x != null )
            {
                x.Written = true ;
                writeLine ( "" ) ;
            }

            DumpInvocation ( invocation , _callDepth ) ;
            invocation.Proceed ( ) ;
            try
            {
                DumpReturnValue ( invocation , _callDepth , ! myX.Written ) ;
                if ( ProxyGenerator            != null
                     && invocation.ReturnValue != null
                     && ! invocation.ReturnValue.GetType ( ).IsSealed
                     && ! ( invocation.ReturnValue is IProxyTargetAccessor ) )
                {
                    var r = invocation.ReturnValue ;
                    if ( r is XamlType typ )
                    {
                        var invoker =
                            ( XamlTypeInvoker ) ProxyGenerator.CreateClassProxyWithTarget (
                                                                                           typeof (
                                                                                               XamlTypeInvoker
                                                                                           )
                                                                                         , typ
                                                                                              .Invoker
                                                                                         , new[]
                                                                                           {
                                                                                               r
                                                                                           }
                                                                                         , this
                                                                                          ) ;
                        object[] args = { typ.UnderlyingType , typ.SchemaContext , invoker } ;


                        invocation.ReturnValue =
                            ProxyGenerator.CreateClassProxyWithTarget (
                                                                       r.GetType ( )
                                                                     , r
                                                                     , args
                                                                     , this
                                                                      ) ;
                    }
                    else if ( r.GetType ( ).IsGenericType
                              && r.GetType ( ).GetGenericTypeDefinition ( )
                              == typeof ( XamlValueConverter < object > )
                                 .GetGenericTypeDefinition ( ) )
                    {
                        object[] args = null ;
                        if ( r is XamlValueConverter < ValueSerializer > q )
                        {
                            args = new object[] { q.ConverterType , q.TargetType , q.Name } ;
                        }
                        else if ( r is XamlValueConverter < TypeConverter > z )
                        {
                            args = new object[] { z.ConverterType , z.TargetType , z.Name } ;
                        }

                        if ( args != null )
                        {
                            invocation.ReturnValue =
                                ProxyGenerator.CreateClassProxyWithTarget (
                                                                           r.GetType ( )
                                                                         , r
                                                                         , args
                                                                         , this
                                                                          ) ;
                        }
                    }
                    else if ( r.GetType ( ).IsGenericType
                              && r.GetType ( ).GetGenericTypeDefinition ( )
                              == typeof ( ReadOnlyCollection < object > )
                                 .GetGenericTypeDefinition ( ) )
                    {
                        var propInfo = r.GetType ( )
                                        .GetField (
                                                   "list"
                                                 , BindingFlags.NonPublic | BindingFlags.Instance
                                                  ) ;
                        if ( propInfo != null )
                        {
                            var args = new[] { propInfo.GetValue ( r ) } ;
                            invocation.ReturnValue =
                                ProxyGenerator.CreateClassProxyWithTarget (
                                                                           r.GetType ( )
                                                                         , r
                                                                         , args
                                                                         , this
                                                                          ) ;
                        }
                    }
                    else if ( r is XamlDirective d )
                    {
                        object[] args =
                        {
                            d.GetXamlNamespaces ( ) , d.Name , d.Type , d.TypeConverter
                          , d.AllowedLocation
                        } ;

                        invocation.ReturnValue =
                            ProxyGenerator.CreateClassProxyWithTarget (
                                                                       r.GetType ( )
                                                                     , r
                                                                     , args
                                                                     , this
                                                                      ) ;
                    }
                    else if ( r is NamespaceDeclaration ns )
                    {
                        invocation.ReturnValue =
                            ProxyGenerator.CreateClassProxyWithTarget (
                                                                       r.GetType ( )
                                                                     , r
                                                                     , new object[]
                                                                       {
                                                                           ns.Namespace , ns.Prefix
                                                                       }
                                                                     , this
                                                                      ) ;
                    }
                    else

                    {
                        try
                        {
                            invocation.ReturnValue =
                                ProxyGenerator.CreateClassProxyWithTarget (
                                                                           r.GetType ( )
                                                                         , r
                                                                         , this
                                                                          ) ;
                        }
                        catch ( InvalidProxyConstructorArgumentsException )
                        {
                            writeLine ( "Constructors for ⮜" + FormatTyp ( r.GetType ( ) ) + "⮞" ) ;
                            foreach ( var constructorInfo in r.GetType ( ).GetConstructors ( ) )
                            {
                                writeLine (
                                           FormatTyp ( constructorInfo.DeclaringType )
                                           + " ( "
                                           + string.Join (
                                                          " , "
                                                        , constructorInfo
                                                         .GetParameters ( )
                                                         .Select (
                                                                  ( info , i )
                                                                      => FormatTyp (
                                                                                    info
                                                                                       .ParameterType
                                                                                   )
                                                                         + " "
                                                                         + info.Name
                                                                         + ( info.HasDefaultValue
                                                                                 ? " = "
                                                                                   + info
                                                                                      .DefaultValue
                                                                                 : "" )
                                                                 )
                                                         )
                                          ) ;
                            }
                        }
                    }
                }
            }
            catch ( Exception ex )
            {
                writeLine ( "--Exception--" ) ;
                writeLine ( ex.ToString ( ) ) ; //.GetType ( ) ) ;
                //Console.WriteLine ( ex.Message ) ;
                writeLine ( "--End Exception--" ) ;
            }
            finally
            {
                _stack.Pop ( ) ;
                Interlocked.Decrement ( ref _callDepth ) ;
            }
        }
    }

    internal class X
    {
        public bool Written ;

        /// <summary>Initializes a new instance of the <see cref="T:System.Object" /> class.</summary>
        public X ( bool written = false ) { Written = written ; }
    }
}