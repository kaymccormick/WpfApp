# Starter pipeline

# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
  branches:
    include:
    - master
  paths:
    include:
    - '*'
    exclude:
    - azure-pipelines-1.yml
    - azure-pipelines-exo.yml
    - azure-pipelines.yml

pool:
  name: exo
  workspace:
    clean: outputs | resources | all 
    
variables:
  buildPlatform: 'x86'
  buildConfiguration: 'Release'

steps:
- checkout: self
  submodules: recursive
  persistCredentials: true

- task: NuGetToolInstaller@1
- task: NuGetCommand@2
  inputs:
    command: 'restore'
    restoreSolution: '*/*.csproj'
    feedsToUse: 'select'
    noCache: true    

- task: NuGetCommand@2
  inputs:
    command: 'restore'
    restoreSolution: 'KayMcCormick*/*/*.csproj'
    feedsToUse: 'select'
    noCache: true    

- task: MsBuildHelperTask@0
  inputs:
    variableName: 'MsBuildAdditionalArguments'
    MsBuildTargetCustom: 'restore;build'
    MsBuildBaseOutputPath: 'StagingDirectory'
    MsBuildOutputPath: 'StagingDirectory'
    TreatWarningsAsError: 'false'
    SkipInvalidConfigurations: 'true'
    GerenateDocumentation: 'true'
- task: MSBuild@1
  inputs:
    solution: '*/*.csproj'
    platform: 'x86'
    configuration: 'Release'
    restoreNugetPackages: false
    msbuildArguments: $(MsBuildAdditionalArguments)

- task: MSBuild@1
  inputs:
    solution: 'KayMcCormick*/*/*.csproj'
    platform: 'x86'
    configuration: 'Release'
    restoreNugetPackages: false
    msbuildArguments: $(MsBuildAdditionalArguments)

- task: CopyFiles@2
  inputs:
    Contents: 'WpfApp/bin/$(BuildPlatform)/$(BuildConfiguration)/*.xml'
    TargetFolder: '$(Build.StagingDirectory)/XmlDocs'
    CleanTargetFolder: true
    flattenFolders: true
    preserveTimestamp: true

- task: CopyFiles@2
  inputs:
    Contents: 'KayMcCormick*/*/bin/$(BuildPlatform)/$(BuildConfiguration)/*.xml'
    TargetFolder: '$(Build.StagingDirectory)/XmlDocs'
    flattenFolders: true
    preserveTimestamp: true

- task: ArchiveFiles@2
  inputs:
    rootFolderOrFile: '$(Build.StagingDirectory)/XmlDocs'
    includeRootFolder: true
    archiveType: 'zip'
    archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
    replaceExistingArchive: true
    verbose: true

- task: VSBuild@1
  inputs:
    solution: '**/*.shfbproj'
    platform: 'x86'
    configuration: 'Release'
    clean: true
    createLogFile: true
    logFileVerbosity: 'diagnostic'

- task: PublishPipelineArtifact@1
  inputs:
    targetPath: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
    artifact: 'XmlDocs'
    publishLocation: 'pipeline'

- task: O365PostMessageRelease@0
  inputs:
    addressType: 'url'
    url: 'https://outlook.office.com/webhook/d3e8f9d8-c43c-4a0b-a2ca-2f7c73a422ea@3956be4f-5b3e-40ee-a904-74d46f3f1b7f/IncomingWebhook/557c0c0963ff495d8930e2d8f5bd650f/07763d67-a182-473a-be2b-2fa3762eea30'
    messageType: 'message'
    title: 'build'
    includeLink: true
    linkText: 'View Release Detail'
